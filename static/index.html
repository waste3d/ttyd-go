<!doctype html>
<html>
<head>
    <title>Go-ttyd</title>
    <link rel="stylesheet" href="node_modules/xterm/css/xterm.css" />
    <link rel="stylesheet" href="css/style.css" />
    <style>
        body { font-family: sans-serif; }
        #info { padding: 10px; color: #ccc; font-size: 12px; }
        #info p { margin: 5px 0; }
        #info code { background-color: #333; padding: 2px 5px; border-radius: 3px; word-break: break-all; }
    </style>
</head>
<body>
<div id="info">
    <p><b>Share this session:</b></p>
    <p>Read & Write: <code id="rw-link"></code></p>
    <p>Read-Only: <code id="ro-link"></code></p>
</div>
<div id="terminal"></div>

<script src="node_modules/xterm/lib/xterm.js"></script>
<script src="node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
<script>
    const termContainer = document.getElementById('terminal');
    const rwLinkEl = document.getElementById('rw-link');
    const roLinkEl = document.getElementById('ro-link');

    const params = new URLSearchParams(window.location.search);
    const roSessionId = params.get('ro');

    let sessionId;
    let isReadOnly = false;
    let wsPath = '/ws/';

    if (roSessionId) {
        sessionId = roSessionId;
        isReadOnly = true;
        wsPath = '/ws-ro/';
    } else if (window.location.hash) {
        sessionId = window.location.hash.substring(1);
    } else {
        sessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
        window.location.hash = sessionId;
    }

    const baseUrl = window.location.origin + window.location.pathname;
    rwLinkEl.textContent = `${baseUrl}#${sessionId}`;
    roLinkEl.textContent = `${baseUrl}?ro=${sessionId}`;

    const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'monospace',
        theme: { background: '#1e1e1e', foreground: '#d4d4d4' },
        disableStdin: isReadOnly
    });

    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    term.open(termContainer);

    function fitTerminal() {
        fitAddon.fit();
        const dims = { type: 'resize', cols: term.cols, rows: term.rows };
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(dims));
        }
    }
    window.onresize = fitTerminal;

    const protocol = (location.protocol === 'https-:') ? 'wss://' : 'ws://';
    const wsUrl = protocol + location.host + wsPath + sessionId;
    const ws = new WebSocket(wsUrl);

    ws.onopen = function() {
        fitTerminal();
        term.focus();
    };

    ws.onmessage = function(event) {
        if (event.data instanceof Blob) {
            const reader = new FileReader();
            reader.onload = function() {
                term.write(new Uint8Array(reader.result));
            };
            reader.readAsArrayBuffer(event.data);
        } else {
            term.write(event.data);
        }
    };

    ws.onclose = function() {
        term.write('\r\n\r\n[CONNECTION CLOSED]\r\n');
    };

    term.onData(function(data) {
        if (!isReadOnly) {
            ws.send(data);
        }
    });
</script>
</body>
</html>