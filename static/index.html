<!doctype html>
<html>
<head>
    <title>Go-ttyd</title>
    <link rel="stylesheet" href="node_modules/xterm/css/xterm.css" />
    <link rel="stylesheet" href="css/style.css" />
    <style>
        body { font-family: sans-serif; }
        #info { padding: 10px; color: #ccc; font-size: 12px; }
        #info code { background-color: #333; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>
<div id="info">
    <p>Для того чтобы поделиться этой сессией, просто скопируйте и отправьте текущий URL из адресной строки.</p>
    <p>Session ID: <code id="session-id"></code></p>
</div>
<div id="terminal"></div>

<script src="node_modules/xterm/lib/xterm.js"></script>
<script src="node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
<script>
    const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'monospace',
        theme: { background: '#1e1e1e', foreground: '#d4d4d4' }
    });

    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    term.open(document.getElementById('terminal'));

    function fitTerminal() {
        fitAddon.fit();
        const dims = { type: 'resize', cols: term.cols, rows: term.rows };
        // Отправляем ресайз только если соединение уже установлено
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(dims));
        }
    }
    window.onresize = fitTerminal;

    // --- НОВАЯ ЛОГИКА РАБОТЫ С СЕССИЯМИ ---
    let sessionId;
    // 1. Проверяем, есть ли ID в URL после символа #
    if (window.location.hash) {
        // Используем существующий ID
        sessionId = window.location.hash.substring(1);
    } else {
        // Генерируем новый ID и добавляем его в URL
        sessionId = Date.now().toString(36) + Math.random().toString(36).substring(2);
        window.location.hash = sessionId;
    }
    document.getElementById('session-id').textContent = sessionId;

    const protocol = (location.protocol === 'https-:') ? 'wss://' : 'ws://';
    const wsUrl = protocol + location.host + '/ws/' + sessionId;
    const ws = new WebSocket(wsUrl);

    ws.onopen = function() {
        console.log("WebSocket connection established for session:", sessionId);
        fitTerminal(); // Подгоняем размер после установки соединения
        term.focus();
    };

    ws.onmessage = function(event) {
        if (event.data instanceof Blob) {
            const reader = new FileReader();
            reader.onload = function() {
                term.write(new Uint8Array(reader.result));
            };
            reader.readAsArrayBuffer(event.data);
        } else {
            term.write(event.data);
        }
    };

    ws.onclose = function() {
        console.log("WebSocket connection closed");
        term.write('\r\n\r\n[CONNECTION CLOSED]\r\n');
    };

    term.onData(function(data) {
        ws.send(data);
    });
</script>
</body>
</html>