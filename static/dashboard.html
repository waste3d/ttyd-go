<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Go-ttyd</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        h1 { border-bottom: 1px solid #444; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #444; padding: 10px 12px; text-align: left; }
        thead { background-color: #2a2a2a; }
        tbody tr:nth-child(odd) { background-color: #252525; }
        a { color: #4e94ce; text-decoration: none; margin-right: 15px; }
        a:hover { text-decoration: underline; }
        .session-id { font-family: monospace; font-size: 0.9em; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .no-sessions td { text-align: center; padding: 30px; color: #888; }
    </style>
</head>
<body>

<h1>Активные сессии</h1>
<table>
    <thead>
    <tr>
        <th>ID Сессии</th>
        <th>Клиенты (Всего / RW / RO)</th>
        <th>Создана</th>
        <th>Ссылки для подключения</th>
    </tr>
    </thead>
    <tbody id="sessions-table-body">
    <!-- Сюда будут добавляться сессии -->
    </tbody>
</table>
<p><a href="/">Перейти к терминалу</a></p>

<script>
    const tbody = document.getElementById('sessions-table-body');

    function renderSessions(sessions) {
        tbody.innerHTML = '';

        if (!sessions || sessions.length === 0) {
            const tr = document.createElement('tr');
            tr.className = 'no-sessions';
            tr.innerHTML = `<td colspan="4">Нет активных сессий</td>`;
            tbody.appendChild(tr);
            return;
        }

        sessions.forEach(session => {
            const tr = document.createElement('tr');

            const createdAt = new Date(session.created_at).toLocaleString();
            const baseUrl = window.location.origin;

            // ИЗМЕНЕНИЕ: Формируем строку с детализацией по клиентам
            const clientsStr = `${session.clients_count_total} (${session.clients_count_rw} RW / ${session.clients_count_ro} RO)`;

            tr.innerHTML = `
                    <td><div class="session-id" title="${session.id}">${session.id}</div></td>
                    <td>${clientsStr}</td>
                    <td>${createdAt}</td>
                    <td>
                        <a href="${baseUrl}/#${session.id}" target="_blank">Read/Write</a>
                        <a href="${baseUrl}/?ro=${session.id}" target="_blank">Read-Only</a>
                    </td>
                `;
            tbody.appendChild(tr);
        });
    }

    async function fetchSessions() {
        try {
            const response = await fetch('/api/sessions');
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const sessions = await response.json();
            renderSessions(sessions);
        } catch (error) {
            console.error("Could not fetch sessions:", error);
            tbody.innerHTML = `<tr class="no-sessions"><td colspan="4">Не удалось загрузить данные.</td></tr>`;
        }
    }

    fetchSessions();
    setInterval(fetchSessions, 2500);
</script>

</body>
</html>